<!DOCTYPE HTML>
<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script src="farbtastic/farbtastic.min.js"></script>
<script src="settings-controls.js"></script>
<script src="noise.js"></script>
<script src="perlin.js"></script>
<script src="basefunctions.js"></script>
<script src="colorfunctions.js"></script>
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/cupertino/jquery-ui.css"> 
<link rel="stylesheet" type="text/css" href="farbtastic/farbtastic.css"> 
<link rel="stylesheet" type="text/css" href="perlin.css"> 
<script>

var noiseOptions = {
  period: {
    name: 'Period',
    description: 'Number of pixels between noise values',
    type: 'slider',
    exponential: true,
    unit: 'pixels',
    min: 10,
    max: 3000,
    defaultValue: 500
  },
  magnitude: {
    name: 'Magnitude',
    description: 'Maximum magnitude of the noise (as % of period)',
    type: 'slider',
    unit: '%',
    min: 0,
    max: 500,
    defaultValue: 80
  },
  type: {
    name: 'Noise type',
    description: 'How noise is applied to input values',
    type: 'select',
    options: ['linear', 'radial'],
    defaultValue: 'linear',
    value: 'linear'
  },
  octaves: {
    name: 'Octaves',
    description: 'How many levels of high frequency (and lower amplitude) noise to add',
    type: 'slider',
    unit: 'levels',
    min: 1,
    max: 8,
    defaultValue: 3
  },
  seed: {
    name: 'Seed',
    description: 'The numberic seed to use in the pseudo-random number generator',
    type: 'number',
    defaultValue: 0
  }
};

var noiseSettings = {};

function Preview(x) {
  var scale = Math.pow(2,x-1),
      himgd, hpix,
      width = 150*scale, height = 100*scale,
      hidden = document.getElementById('hidden' + x),
      baseFunction = $('#baseFunctionSelect').val(),
      colorFunction = $('#colorFunctionSelect').val();
      
  hContext = hidden.getContext('2d');
  himgd = hContext.createImageData(width,height);
  hpix = himgd.data;
  
  /*
  var baseFunctionOptions = {};
  for (var o in baseFunctions[baseFunction].options) {
    baseFunctionOptions[o] = baseFunctions[baseFunction].options[o].value;
  }
  console.log(baseFunctionOptions);
  */
  
  var imageOptions = {
    baseFunction: baseFunction,
    baseFunctionOptions: baseFunctionsSettings[baseFunction],
    colorFunction: colorFunction,
    colorFunctionOptions: colorFunctionsSettings[colorFunction],
    perlinOptions: {
      octaves: noiseSettings.octaves,
      period: noiseSettings.period,
      magnitude: noiseSettings.magnitude * noiseSettings.period / 100,
      type: noiseSettings.type,
      seed: noiseSettings.seed
    }
  }
  
  PerlinTubulence.makeImage(hpix, imageOptions, width, height, 4/scale);
  hContext.putImageData(himgd, 0, 0);
  hurl = hidden.toDataURL();
  $('#previewImage').attr('src', hurl);
}


function TestStretch() {
  var x=1;
  var max = 3;
  function DoPreview() {
    setTimeout(function() {
      Preview(x);
      console.log("did preview " + x);
      if (x<max) {
        x++;
        DoPreview();
      }
    },10);
  }
  DoPreview();
}

var baseFunctions;
var baseFunctionsSettings = {};
var colorFunctions;
var colorFunctionsSettings = {};

var activeTab = 'noiseSettingsBlock';

$(function() {
  var settingsBlock, blockID;
  
  //copyTest();

  noiseSettings = SettingsOptions.getDefaultSettings(noiseOptions);
  SettingsOptions.makeControls('noiseOptions', noiseOptions, noiseSettings);
  
  baseFunctions = PerlinTubulence.getBaseFunctions();
  $.each(baseFunctions, function(key, baseFunction) {
     $('#baseFunctionSelect')
         .append($("<option></option>")
         .attr("value",key)
         .text(baseFunction.name));
     blockID = 'baseFunction' + key;
     $settingsBlock = $('<div id="' + blockID + '" class="baseFunctionSettings settingsBlock">');
     $('#baseFunctionBlocks').append($settingsBlock);
     
     baseFunctionsSettings[key] = SettingsOptions.getDefaultSettings(baseFunction.options);
     SettingsOptions.makeControls(blockID, baseFunction.options, baseFunctionsSettings[key]);
     
  });

  colorFunctions = PerlinTubulence.getColorFunctions();
  $.each(colorFunctions, function(key, colorFunction) {
     $('#colorFunctionSelect')
         .append($("<option></option>")
         .attr("value",key)
         .text(colorFunction.name));
     blockID = 'colorFunction' + key;
     $settingsBlock = $('<div id="' + blockID + '" class="colorFunctionSettings settingsBlock">');
     $('#colorFunctionBlocks').append($settingsBlock);
     
     colorFunctionsSettings[key] = SettingsOptions.getDefaultSettings(colorFunction.options);
     SettingsOptions.makeControls(blockID, colorFunction.options, colorFunctionsSettings[key]);
     
  });

  showActiveBaseFunction();
  $('#baseFunctionSelect').change(function(e) {
   showActiveBaseFunction();
  });

  showActiveColorFunction();
  $('#colorFunctionSelect').change(function(e) {
   showActiveColorFunction();
  });

  $('#drawButton').click(function(e) {
    TestStretch();
  });

  setActiveTab('noiseTab');
  
  $('.settingsTab').click(function() {
    setActiveTab($(this).attr('id'));
  });
  
  TestStretch();
  
});

function showActiveBaseFunction() {
  var id = $('#baseFunctionSelect').val();
  $('.baseFunctionSettings').hide();
  $('#baseFunction' + $('#baseFunctionSelect').val()).show();
}

function showActiveColorFunction() {
  var id = $('#colorFunctionSelect').val();
  $('.colorFunctionSettings').hide();
  $('#colorFunction' + $('#colorFunctionSelect').val()).show();
}

function setActiveTab(tabID) {
  switch(tabID) {
    case 'noiseTab':
      activeBlock = 'noiseSettingsBlock';
      break;
    case 'baseTab':
      activeBlock = 'baseSettingsBlock';
      break;
    case 'colorTab':
      activeBlock = 'colorSettingsBlock';
      break;
  }
  $('.settingsTab').css({opacity:0.5});
  $('#' + tabID).css({opacity:1});
  $('.settingsBlockWrapper').hide();
  $('#' + activeBlock).show();
}

function copyTest() {
  var w=1000, h=1000, x, y;
  
  var t1 = Date.now();
  var a1 = new Array(w*h);
  var t2 = Date.now();
  console.log("Make array: " + (t2 - t1));
  
  for (y=0; y<h; y++) {
    for (x=0; x<w; x++) {
      a1[y*h + w] = 255;
    }
  }
  var t3 = Date.now();
  console.log("Fill array: " + (t3 - t2));

  var a2 = new Array(w*h);
  var t4 = Date.now();
  for (y=0; y<h; y++) {
    for (x=0; x<w; x++) {
      a2[y*h + w] = a1[y*h + w];
    }
  }
  var t5 = Date.now();
  console.log("Copy array: " + (t5 - t4));

}

</script>
</head>
<body>
  <div id="main">
    <div id="left">
      <div id="previewImageWrapper">
        <img id="previewImage"></img>
      </div>
      <h3 id="drawButton">Preview</h3>
    </div>
    <div id="right">
      <div id="tabsWrapper">
        <div class="settingsTab" id="noiseTab">Noise</div>
        <div class="settingsTab" id="baseTab">Base</div>
        <div class="settingsTab" id="colorTab">Color</div>
      </div>
      <div style="clear:both"></div>
      <div class="settingsBlockWrapper" id="noiseSettingsBlock">
        <h3>Noise settings</h3>
        <div id="noiseOptions" class="settingsBlock">
        </div>
      </div>
      <div class="settingsBlockWrapper" id="baseSettingsBlock">
        <h3>Base function</h3>
        <select id="baseFunctionSelect"></select>
        <div id="baseFunctionBlocks"></div>
      </div>
      <div class="settingsBlockWrapper" id="colorSettingsBlock">
        <h3>Color function</h3>
        <select id="colorFunctionSelect"></select>
        <div id="colorFunctionBlocks"></div>
      </div>
    </div>
  </div>
  <canvas id="hidden1" width="150" height="100" style="display:none;">
    <p>this browser does not support the canvas API</p>
  </canvas>
  <canvas id="hidden2" width="300" height="200" style="display:none;">
    <p>this browser does not support the canvas API</p>
  </canvas>
  <canvas id="hidden3" width="600" height="400" style="display:none;">
    <p>this browser does not support the canvas API</p>
  </canvas>
</body>
</html>